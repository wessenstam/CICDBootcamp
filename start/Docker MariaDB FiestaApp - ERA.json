{"status":{},"contains_secrets":false,"product_version":"3.1.0","spec":{"description":"Docker build VM","resources":{"client_attrs":{"None":{"y":522.5,"x":572.5},"6295200f_deployment":{"y":149.5,"x":223.5},"1188c336_deployment":{"y":145.5,"x":423.5},"b562adc4_deployment":{"y":147.1003911703,"x":612.2370031755}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"201bf1d8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4b34bc84_runbook","main_task_local_reference":{"kind":"app_task","name":"201bf1d8_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9771a791_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"897d60a6_runbook","main_task_local_reference":{"kind":"app_task","name":"9771a791_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"af0a7bea_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8b4a8d5c_runbook","main_task_local_reference":{"kind":"app_task","name":"af0a7bea_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"178fb5b9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"17fc7fe9_runbook","main_task_local_reference":{"kind":"app_task","name":"178fb5b9_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ad96baec_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f46d5c6c_runbook","main_task_local_reference":{"kind":"app_task","name":"ad96baec_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Docker Build","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"21c6e337_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6a67a525_runbook","main_task_local_reference":{"kind":"app_task","name":"21c6e337_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e9235a34_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7e1e71a7_runbook","main_task_local_reference":{"kind":"app_task","name":"e9235a34_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7973b2aa_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"727370c9_runbook","main_task_local_reference":{"kind":"app_task","name":"7973b2aa_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"29687a2c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f45bb754_runbook","main_task_local_reference":{"kind":"app_task","name":"29687a2c_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8c1ea319_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"08286a9d_runbook","main_task_local_reference":{"kind":"app_task","name":"8c1ea319_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"MariaDB","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"21c6e337_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6a67a525_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"21c6e337_dag_cloned_1"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e9235a34_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7e1e71a7_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"e9235a34_dag_cloned_1"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7973b2aa_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"727370c9_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"7973b2aa_dag_cloned_1"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"29687a2c_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"f45bb754_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"29687a2c_dag_cloned_1"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8c1ea319_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"08286a9d_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"8c1ea319_dag_cloned_1"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Fiesta","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"Docker_VM","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{initials}@@-docker_VM","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"ebdff067-77d6-4f4b-b009-7c7526c4f3bb"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":2,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\npreserve_hostname: false\nhostname: @@{initials}@@-dcoker-vm\nssh_pwauth: true\nusers:\n  - name: centos\n    chpasswd: { expire: False }\n    lock-passwd: false\n    plain_text_passwd: 'nutanix\/4u'\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nruncmd:\n  - setenforce 0\n  - sed -i s\/^SELINUX=.*$\/SELINUX=disabled\/ \/etc\/selinux\/config\n  - systemctl disable firewalld\n  - systemctl stop firewalld"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"04968afa-db11-45be-922d-3340bc47c675","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"CentOS_PHX_DFS","uuid":"fbb54d56-9469-44f4-96c9-38ab6cd7663f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":102400,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"MariaDB_VM","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"90","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{initials}@@-MariaDB_VM","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"ebdff067-77d6-4f4b-b009-7c7526c4f3bb"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":2048,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\npreserve_hostname: false\nhostname: @@{initials}@@-mariadb-vm\nssh_pwauth: true\nusers:\n  - name: centos\n    chpasswd: { expire: False }\n    lock-passwd: false\n    plain_text_passwd: 'nutanix\/4u'\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nruncmd:\n  - setenforce 0\n  - sed -i s\/^SELINUX=.*$\/SELINUX=disabled\/ \/etc\/selinux\/config\n  - systemctl disable firewalld\n  - systemctl stop firewalld"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"04968afa-db11-45be-922d-3340bc47c675","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"CentOS_PHX_DFS","uuid":"fbb54d56-9469-44f4-96c9-38ab6cd7663f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"Fiesta_App_VM","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"90","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{initials}@@-Fiesta_App_VM","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"ebdff067-77d6-4f4b-b009-7c7526c4f3bb"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":2048,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\npreserve_hostname: false\nhostname: @@{initials}@@-fiestaapp-vm\nssh_pwauth: true\nusers:\n  - name: centos\n    chpasswd: { expire: False }\n    lock-passwd: false\n    plain_text_passwd: 'nutanix\/4u'\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nruncmd:\n  - setenforce 0\n  - sed -i s\/^SELINUX=.*$\/SELINUX=disabled\/ \/etc\/selinux\/config\n  - systemctl disable firewalld\n  - systemctl stop firewalld"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"04968afa-db11-45be-922d-3340bc47c675","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"CentOS_PHX_DFS","uuid":"fbb54d56-9469-44f4-96c9-38ab6cd7663f"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"root","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CentOS"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Docker Build"}],"name":"Installation Docker VM","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation Docker VM"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Run Update CentOS"},{"kind":"app_task","name":"Preparation for Docker"},{"kind":"app_task","name":"Install Docker"}],"name":"870bda0b_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Run Update CentOS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Preparation for Docker"}},{"from_task_reference":{"kind":"app_task","name":"Preparation for Docker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install Docker"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Run Update CentOS","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nhostnamectl set-hostname @@{initials}@@-docker-vm\n\nyum update -y\nyum upgrade -y","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Preparation for Docker","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# Install the needed tools\nyum install -y util-linux git\n\n# Create the second disk and use it\n(\necho o # Create a new empty DOS partition table\necho n # Add a new partition\necho p # Primary partition\necho 1 # Partition number\necho   # First sector (Accept default: 1)\necho   # Last sector (Accept default: varies)\necho w # Write changes\n) | sudo fdisk \/dev\/sdb\n\nsleep 10\nmkfs.ext4 \/dev\/sdb1\n\nsleep 10\n# Create the Docker mountpoints and mount it to the second drive\nsudo mkdir -p \/docker-location\nmount \/dev\/sdb1 \/docker-location\n\n# Add mount point to fstab\ndrive_uuid=$(blkid \/dev\/sdb1 | cut -d \"\\\"\" -f 2)\nsudo echo \"UUID=$drive_uuid\t\/docker-location\text4\tdefaults\t1 3\" | sudo tee -a \/etc\/fstab","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Docker Build"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Docker","attrs":{"script":"#!\/bin\/bash\n# Grab the installaition file\ncurl -fsSL https:\/\/get.docker.com\/ | sh\n\n# stopping docker\nsystemctl stop docker\nsleep 10\n\n# Change docker location to the new location\nsudo mkdir -p \/docker-location\/docker\nsudo mkdir -p \/etc\/docker\nsudo touch \/etc\/docker\/daemon.json\nsudo echo '{\"data-root\": \"\/docker-location\/docker\",\"storage-driver\": \"overlay2\"}' > \/etc\/docker\/daemon.json\nsudo rsync -aP \/var\/lib\/docker\/ \/docker-location\/docker\nsudo rm -Rf \/var\/lib\/docker\/\n\nsleep 5\n# Start and enable the docker engine at boot time\nsystemctl start docker\nsystemctl status docker\nsystemctl enable docker\ndocker info\n\n# Adding the centos user to the docker group\nusermod -aG docker centos\n\n# Install docker-compose\nyum install -y docker-compose\n\n# Shutdown and reboot after 1 minute\nshutdown -r --no-wall","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"ca963bc1_runbook","main_task_local_reference":{"kind":"app_task","name":"870bda0b_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation Docker VM"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bf06f506_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"11e85c66_runbook","main_task_local_reference":{"kind":"app_task","name":"bf06f506_dag"},"variable_list":[]}},"variable_list":[]},{"description":"CentOS_PHX_DFS","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"CentOS_PHX_DFS","version":"","options":{"type":"","name":"CentOS-PHX-DFS","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/10.42.194.11\/workshop_staging\/CentOS7.qcow2","version":{"product_version":"7","type":"","product_name":"CentOS"},"architecture":"X86_64","type":""},"description":""},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"MariaDB"}],"name":"Installation MariaDB","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Update OS"},{"kind":"app_task","name":"Install MariaDB"},{"kind":"app_task","name":"Initial install MariaDB"},{"kind":"app_task","name":"Setup FiestaDB in MariaDB"},{"kind":"app_task","name":"Register with Era instance"}],"name":"b3e19fac_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Update OS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install MariaDB"}},{"from_task_reference":{"kind":"app_task","name":"Install MariaDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Initial install MariaDB"}},{"from_task_reference":{"kind":"app_task","name":"Initial install MariaDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Setup FiestaDB in MariaDB"}},{"from_task_reference":{"kind":"app_task","name":"Setup FiestaDB in MariaDB"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register with Era instance"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Update OS","attrs":{"script":"#!\/bin\/bash\nhostnamectl set-hostname @@{initials}@@-mariadb-vm\necho 127.0.0.1 @@{initials}@@-mariadb-vm | tee -a \/etc\/hosts\n\n# Remove NetworkManager as this has a bad influence on Era when cloning happens\nyum remove -y NetworkManager\n\n# update the O\/S to the latest packages\nyum update -y\nyum upgrade -y","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install MariaDB","attrs":{"script":"#!\/bin\/bash\nsudo yum install -y mariadb mariadb-server git\nsudo yum install zip unzip jq -y","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Initial install MariaDB","attrs":{"script":"#!\/bin\/bash\n# Get the MariaDB initial install done\nsudo \/usr\/bin\/mysql_install_db --user=mysql --ldata=\/var\/lib\/mysql\nsudo mkdir \/run\/mysqld\nsudo chown mysql:mysql \/run\/mysqld\n\n# Making sure the MariaDB starts at boot time\nsudo systemctl enable mariadb\nsudo systemctl start mariadb\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Setup FiestaDB in MariaDB","attrs":{"script":"#!\/bin\/bash\n# Get the original data from the github\nsudo mkdir \/code\nsudo git clone https:\/\/github.com\/sharonpamela\/Fiesta \/code\/Fiesta\n\n# Inject the data into the MariaDB\nsudo mysql < \/code\/Fiesta\/seeders\/FiestaDB-mySQL.sql\n\n# Getting the correct rights for the fiesta user based on the variables we need.\nsudo echo \"grant all privileges on FiestaDB.* to fiesta@'%' identified by 'fiesta';\" | sudo mysql\nsudo echo \"grant all privileges on FiestaDB.* to fiesta@localhost identified by 'fiesta';\" | sudo mysql\n\n# Changing my.cnf so MariaDB is running Binary Logs\nsudo sed -i 's\/socket=\\\/var\\\/lib\\\/mysql\\\/mysql.sock\/socket=\\\/var\\\/lib\\\/mysql\\\/mysql.sock\\nlog_bin=\\\/var\\\/log\\\/mariadb\\\/mariadb-bin.log\/g' \/etc\/my.cnf\nsudo systemctl daemon-reload\nsudo systemctl restart mariadb\n\n# Setting the Root password for mysql\nsudo mysqladmin --user=root password 'nutanix\/4u'","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register with Era instance","attrs":{"script":"#!\/bin\/bash\n\nfunction waitloop {\n  op_answer=\"$1\"\n  loop=$2\n  # Get the op_id from the task\n  op_id=$(echo $op_answer | jq '.operationId' | tr -d \\\")\n\n\n  # Checking on error. if we have received an error, show it and exit 1\n  if [[ -z $op_id ]]\n  then\n      echo \"We have received an error message. The reply from the Era system has been \"$op_answer\" ..\"\n      exit 1\n  else   \n    counter=1\n    # Checking routine to see that the registration in Era worked\n    while [[ $counter -le $loop ]]\n    do\n        ops_status=$(curl -k --silent https:\/\/${era_ip}\/era\/v0.9\/operations\/${op_id} -H 'Content-Type: application\/json' --user @@{era_admin}@@:@@{era_passwd}@@ | jq '.[\"percentageComplete\"]' | tr -d \\\")\n        if [[ $ops_status == \"100\" ]]\n        then\n            ops_status=$(curl -k --silent https:\/\/${era_ip}\/era\/v0.9\/operations\/${op_id} -H 'Content-Type: application\/json' --user @@{era_admin}@@:@@{era_passwd}@@ | jq '.status' | tr -d \\\")\n            if [[ $ops_status == \"5\" ]]\n            then\n               echo \"Database and Database server have been registreed in Era...\"\n               break\n            else\n               echo \"Database and Database server registration not correct. Please look at the Era GUI to find the reason...\"\n               exit 1\n            fi\n        else\n            echo \"Operation still in progress, it is at $ops_status %... Sleep for 30 seconds before retrying.. ($counter\/$loop)\"\n            sleep 30        \n        fi\n        counter=$((counter+1))\n    done\n    if [[ $counter -ge $loop ]]\n    then\n      echo \"We have tried for \"$(expr $loop \/ 2)\" minutes to register the MariaDB server and Database, but were not successful. Please look at the Era GUI to see if anything has happened...\"\n    fi\nfi\n}\n\n# Install the unzip for the Era registration\nsudo yum install zip unzip jq -y\n\n# Create the Era server network\nip_network=$(sudo ifconfig eth0 | grep inet | grep -v inet6 | tr -s \" \" |tr \" \" \",\" | cut -d \",\" -f 3 | cut -d \".\" -f 1,2,3)\nera_ip=@@{era_ip}@@\n\n# If the variable era_ip is not set, set it using the stage script calculations\nif [[ -z $era_ip ]]\nthen \n\tera_ip=$ip_network\".44\"\nfi\n\nown_ip=$(sudo ifconfig eth0 | grep inet | grep -v inet6 | tr -s \" \" |tr \" \" \",\" | cut -d \",\" -f 3)\n\n# Get the UUID of the Era server\nera_uuid=$(curl -k --insecure --silent https:\/\/${era_ip}\/era\/v0.9\/clusters -H 'Content-Type: application\/json' --user @@{era_admin}@@:@@{era_passwd}@@ | jq '.[].id' | tr -d \\\")\n\n# Get the UUID of the none TM SLA schedule from Era\nsla_uuid=$(curl -k --insecure --silent https:\/\/${era_ip}\/era\/v0.9\/slas -H 'Content-Type: application\/json' --user @@{era_admin}@@:@@{era_passwd}@@ | jq '.[] | select (.name==\"DEFAULT_OOB_BRONZE_SLA\") .id' | tr -d \\\")\n\n# Create the needed network profile\necho \"We are creating it....\"\nop_answer=$(curl -k -X POST \\\n\thttps:\/\/${era_ip}\/era\/v0.9\/profiles \\\n\t-H 'Content-Type: application\/json' \\\n\t-H 'Authorization: Basic YWRtaW46dGVjaFgyMDIxIQ==' \\\n\t-d \\\n\t'{\"engineType\":\"mariadb_database\",\"type\":\"Network\",\"topology\":\"ALL\",\"dbVersion\":\"ALL\",\"systemProfile\":false,\"properties\":[{\"name\":\"VLAN_NAME\",\"value\":\"Secondary\",\n    \t\t\t \"secure\":false,\"description\":\"Era Managed VLAN\"}],\"versionClusterAssociation\":[{\"nxClusterId\":\"'$era_uuid'\"}],\"name\":\"Era_Managed_MariaDB\"}')\n\n# Sleep for 5 seconds so the Era server can create the network profile\nsleep 5\n\n# Registering DB and DBServer, to the Era server and assign the reply to an variable\nop_answer=$(curl -k --silent -X POST \\\n\thttps:\/\/${era_ip}\/era\/v0.9\/databases\/register \\\n\t-H 'Content-Type: application\/json' \\\n\t--user @@{era_admin}@@:@@{era_passwd}@@ \\\n\t-d \\\n\t'{\"actionArguments\":[{\"name\":\"listener_port\",\"value\":\"3306\"},\n    {\"name\":\"db_user\",\"value\":\"root\"},{\"name\":\"vmIp\",\"value\":\"'${own_ip}'\"},\n    {\"name\":\"software_home\",\"value\":\"\/usr\"},\n    {\"name\":\"db_name\",\"value\":\"FiestaDB\"},\n    {\"name\":\"db_password\",\"value\":\"nutanix\/4u\"}],\n    \"nxClusterId\":\"'${era_uuid}'\",\n    \"databaseType\":\"mariadb_database\",\"databaseName\":\"@@{initials}@@-FiestaDB\",\n    \"description\":\"@@{initials}@@-FiestaDB Database\",\"clustered\":false,\"forcedInstall\":true,\"category\":\"DEFAULT\",\n    \"vmIp\":\"'${own_ip}'\",\"vmUsername\":\"centos\",\"vmPassword\":\"nutanix\/4u\",\"vmSshkey\":\"\",\n    \"vmDescription\":\"\",\"autoTuneStagingDrive\":true,\"workingDirectory\":\"\/tmp\",\n    \"timeMachineInfo\":{\"autoTuneLogDrive\":true,\"slaId\":\"'${sla_uuid}'\",\n    \"schedule\":{\"snapshotTimeOfDay\":{\"hours\":1,\"minutes\":0,\"seconds\":0},\"continuousSchedule\":{\"enabled\":true,\"logBackupInterval\":30,\n    \"snapshotsPerDay\":1},\"weeklySchedule\":{\"enabled\":true,\"dayOfWeek\":\"TUESDAY\"},\"monthlySchedule\":{\"enabled\":true,\"dayOfMonth\":\"17\"},\n    \"quartelySchedule\":{\"enabled\":true,\"startMonth\":\"JANUARY\",\"dayOfMonth\":\"17\"},\"yearlySchedule\":{\"enabled\":false,\"dayOfMonth\":31,\"month\":\"DECEMBER\"}},\n    \"tags\":[],\"name\":\"@@{initials}@@-FiestaDB_TM\"},\"tags\":[]}')\n# Call the wait function\nwaitloop \"$op_answer\" 20\n    ","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"99d6386c_runbook","main_task_local_reference":{"kind":"app_task","name":"b3e19fac_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation MariaDB"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c2460eef_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"1ce86388_runbook","main_task_local_reference":{"kind":"app_task","name":"c2460eef_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Fiesta"}],"name":"Installation FiestaApp","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation FiestaApp"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Update OS"},{"kind":"app_task","name":"Install npm"},{"kind":"app_task","name":"Start the Fiesta App"}],"name":"b3e19fac_dag_cloned_1","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Update OS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install npm"}},{"from_task_reference":{"kind":"app_task","name":"Install npm"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Start the Fiesta App"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Update OS","attrs":{"script":"#!\/bin\/bash\nhostnamectl set-hostname @@{initials}@@-fiestaapp-vm\n\nyum update -y\nyum upgrade -y","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install npm","attrs":{"exit_status":[],"script":"#!\/bin\/bash\n# INstall the needed packages\nsudo yum install -y mysql mysql-client git gcc curl wget vim gcc-c++\n\n# Install node\ncurl -sL https:\/\/rpm.nodesource.com\/setup_10.x | sudo bash -\nsudo yum install -y nodejs\nnode --version\n\n# Clone Repo\ngit clone https:\/\/github.com\/sharonpamela\/Fiesta.git \/code\/Fiesta\ncd \/code\/Fiesta\nnpm install\ncd \/code\/Fiesta\/client\nnpm install\nnpm run build\nnpm install nodemon concurrently\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CentOS"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Fiesta"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Start the Fiesta App","attrs":{"script":"#!\/bin\/bash\n\n\n# Change the code so it works in the container\nsed -i 's\/REPLACE_DB_NAME\/FiestaDB\/g' \/code\/Fiesta\/config\/config.js\nsed -i \"s\/REPLACE_DB_HOST_ADDRESS\/@@{MariaDB.address}@@\/g\" \/code\/Fiesta\/config\/config.js\nsed -i \"s\/REPLACE_DB_DIALECT\/mysql\/g\" \/code\/Fiesta\/config\/config.js\nsed -i \"s\/REPLACE_DB_USER_NAME\/fiesta\/g\" \/code\/Fiesta\/config\/config.js\nsed -i \"s\/REPLACE_DB_PASSWORD\/fiesta\/g\" \/code\/Fiesta\/config\/config.js\nsed -i 's\/REPLACE_DB_DOMAIN_NAME\/\\\/\\\/DB_DOMAIN_NAME\/g' \/code\/Fiesta\/config\/config.js\n\n\n# Create the unit file\necho '[Service]\n\nExecStart=\/usr\/bin\/node \/code\/Fiesta\/index.js\nRestart=always\nRestartSec=2s\n\nStandardOutput=syslog\nStandardError=syslog\n\nSyslogIdentifier=fiesta\n\nUser=root\nGroup=root\n\nEnvironment=NODE_ENV=production PORT=5001\n\n[Install]\nWantedBy=multi-user.target' | sudo tee \/etc\/systemd\/system\/fiesta.service\n\n# Reload daemons and start service\nsudo systemctl daemon-reload\nsudo systemctl start fiesta\nsudo systemctl enable fiesta\nsudo systemctl status fiesta -l","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"99d6386c_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"b3e19fac_dag_cloned_1"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Installation FiestaApp"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c2460eef_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"1ce86388_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"c2460eef_dag_cloned_1"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"b562adc4_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Installation Docker VM"}],"substrate_local_reference":{"kind":"app_substrate","name":"Docker_VM"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"6295200f_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Installation MariaDB"}],"substrate_local_reference":{"kind":"app_substrate","name":"MariaDB_VM"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"1188c336_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Installation FiestaApp"}],"substrate_local_reference":{"kind":"app_substrate","name":"Fiesta_App_VM"},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"initials","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_ip","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_admin","value":"admin","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"era_passwd","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CentOS"},"type":"USER"},"name":"Docker MariaDB FiestaApp - ERA"},"api_version":"3.0","metadata":{"last_update_time":"1607674765983016","kind":"blueprint","spec_version":4,"creation_time":"1607615583437424","name":"Docker MariaDB FiestaApp - ERA"}}
